const { SmartBuffer } = require("smart-buffer");
const Handler = require("../../Utils/Handler");
const { opCode } = require("../../Utils/opcode");
const packetHandler = require("../../Utils/packetHandler");
const character = require("../Character/Util/character");

class GameHandler extends Handler {
  constructor(session) {
    super(session);
  }

  handleClientEnterGameServer() {
    const buf = SmartBuffer.fromBuffer(this._data);
    const accountKey = buf.readUInt32LE();
    const charID = buf.readUInt32LE();
    this.sendTimestamp(() => {
      this.sendServerVersion(() => {
        this.write("0x2A30", Buffer.from("E9030000018013D05F00000000FF37FE5F0000000014000000000000", "hex"), () => {
          this.writeEventBooster(() => {
            this.write("0x1753", Buffer.from("BB4739000040C9430040C943", "hex"), () => {
              this.write("0x2902", Buffer.from("022007FB33020000000000", "hex"), () => {
                this.write("0x0322", Buffer.from("000000000177527DAD0100775204009D93B047FD10A44747F9CC4600007041000000000000000000", "hex"), () => {
                  this.write(
                    "0x3306",
                    Buffer.from("6D520000F4CDDD5F0000000020CFDD5F0000000004DCDD5F0000000030DDDD5F0000000024F8DD5F0000000050F9DD5F00000000", "hex"),
                    () => {
                      this.write("0x0656", Buffer.from("05000001000B001500000000000000", "hex"), () => {
                        this.write(
                          "0x2A01",
                          Buffer.from(
                            "F40300004C9BCC5F00000000E77BDA5F0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002010200000001E77BDA5F000000000102000000000500000000000000519BCC5F000000000102000000",
                            "hex"
                          ),
                          () => {
                            this.write("0x0866", Buffer.alloc(4), () => {
                              this.write("0x0868", Buffer.alloc(5), () => {
                                this.write(
                                  "0x0334",
                                  Buffer.from(
                                    "00BB4739001B0000C8420300000040400400000040400500000040400600000040400700000040400800000040400D000000C8420E000000A0400F000000484211003333B34214000000E04215000000F04216000000164317000000F0401800000016421900000E49441A0000C08C421B00000048421C000000803F1D000000C03E1E009A99993E20003333B34223000000403F2400BC74933C26000000403F",
                                    "hex"
                                  ),
                                  () => {
                                    this.write(
                                      "0x0334",
                                      Buffer.from("00BB4739000600C08F44010000004843020000C08F440A00000048430C000000C84212000000C8421300", "hex"),
                                      () => {
                                        this.write("0x2A05", Buffer.alloc(0), () => {
                                          this.write("0x0105", Buffer.from("3C8D797C00000000AC610814"), () => {
                                            this.write("0x0330", Buffer.alloc(0), () => {});
                                          });
                                        });
                                      }
                                    );
                                  }
                                );
                              });
                            });
                          }
                        );
                      });
                    }
                  );
                });
              });
            });
          });
        });
      });
    });
  }

  sendDummyChar() {
    this.write(
      "0x0332",
      Buffer.from(
        "BB4739000C004400530044004F0044004F000100E9030000000000004D043508ED131D0C00000000000000000104EA800A00000000000000E5E59D0600FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF0000000001000000F5994C01BD39940C00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF0000000003000000F5994C014D3B940C00000000FFFFFFFFFFFFFFFFFFFFFFFF0000000002000000F5994C01B13B940C00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF0000000004000000F5994C01213A940C00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000007E0400007E040000C8000000C80000000000000000000000640000006400000000000000000000000000C8420000C842000000C800000000000000000000000000000000000000000000000000010000000077527DAD0100775204009D93B047FD10A44747F9CC46000070410040C9430040C9430000000000000000000000000000000000000000BF3EFFDF196D3F1C0000000000000000000000000000000000000000000000000900313532303638353537000000000000000000000000000000000000000000000101",
        "hex"
      ),
      () => {
        this.write(
          "0x0670",
          Buffer.from(
            "00000000000000000000000003000C004BB7B700000000007B2CB80000000000D31BB70000000000ABA1B800000000006F000000000000002F4AAA00000000000B000000000000009B7AB800000000008B53B80000000000BBC8B800000000009B1CB70000000000BB1FB700000000000C004BB7B700000000007B2CB80000000000D31BB70000000000ABA1B800000000006F000000000000002F4AAA00000000000B000000000000009B7AB800000000008B53B80000000000BBC8B800000000009B1CB70000000000BB1FB700000000000C0000D31BB7009B1CB700BB1FB7000000000001009B1CB7000000000000000000000000000200BB1FB7000000000000000000000000000300000000000000000000000000000000000400000000000000000000000000000000000500000000000000000000000000000000001E00000000000000000000000000000000001F0000000000000000000000000000000000200000000000000000000000000000000000210000000000000000000000000000000000220000000000000000000000000000000000230000000000000000000000000000000000000200000001000B00150000000500000000000000000000",
            "hex"
          ),
          () => {
            this.write("0x2801", Buffer.alloc(14), () => {
              this.write("0x0109", Buffer.from("0200000000000000", "hex"), () => {
                this.write("0x0107", Buffer.from("010101010101000001010001010001", "hex"), () => {
                  this.write("0x0362", Buffer.alloc(1), () => {
                    this.write("0x0362", Buffer.alloc(2), () => {
                      this.write("0x1164", Buffer.from("00BB47390001", "hex"), () => {});
                    });
                  });
                });
              });
            });
          }
        );
      }
    );
  }

  writeEventBooster(cb) {
    this.write(
      "0x2A20",
      Buffer.from(
        "D300DC522914DD520114E5520114E6520114E7521514FA5215144053151441530B144953F7134A531514555329145E5301145F530114A453F713A5530B14AD531F14B753F713B8531F14C253F713C3530B1408541514125401141D541F142654151427540B145F560B1460560114615633146A56F7137356F71375561514C5561F14CD560114CE560B14CF561F14D8560114E1560B14E3561F143157F71332570B14335729143C5701143D5701144657011447571F1496570B149757F713A0571F14A1570B14A9573314AB570B14EF571514F057F713F1570114FB57011403580B140558F7130E58F713515A0114525A1F14535A15145B5A2914675A1514AB5A1514AC5A1514B65AF713C15A0114CA5A1514CB5AF713105B1F141A5B1F141B5B0114235B1514255B1F142D5B0B142F5B1F14745B15147E5B0114875B0114885B0B14895B1F14915B0B14935B3314E15BF713E25B1F14E35B1514EB5B0B14ED5B0B143C5C0B143D5C0114455CF713465C0114475C1F14505C2914315E3314445EF713455E3314945EF713955E33149D5E0114A75E0B14A95E0114B35E1514F75E1514F85E0B14025FF713035F33140D5F0114165F1514175F01145C5FF713675FF713705F01147A5FF7137B5FF713BF5F0114C05F0114C15F0B14D35F0B14DE5F1F14DF5F011423601514246001142E600B143960F7134260331443600B14876015149160F71392601F149D600B14A660F713A7600B141862F71319620B14216201142C620B142D621F143662F713376215147D62F71391620B149962F7139A62F7139B621514E0621F14E1621514F5623314FF62151444630B14456301144D63F7134F631514586301146163F713626329140166011414661514156601141F660B14646601146E66F7137866331479660B1483661514C8660B14C9660B14D2663314D3662914DB66F713E7660B142C67F7132D67331435670B14376729143F670B144B670B149067F713916701149A6701149B67F713A467F713A5670B14FD670B14FF67151407680B1408681F1409682914136801145768F71358681F145968F71363681F146C680B146D680B147568F713E9692914F2690114F3690B14FD6901144D6A0114576A0B14606A0B146B6AF713B16A1F14BA6A1F14C36A0B14C56AF713156B29141F6B1F14286B0B14",
        "hex"
      ),
      cb
    );
  }

  sendServerVersion(cb) {
    this._session.getClient().write(
      packetHandler.encrypt({
        opcode: "0x0404",
        //data: new SmartBuffer().writeInt32LE(0).writeInt32LE(0).writeInt32LE(0).writeInt32LE(0).toBuffer(),
        data: Buffer.from("00000000010000004303000073410000", "hex"),
      }),
      () => {
        cb();
      }
    );
  }

  sendTimestamp(cb) {
    const date = new Date();
    const unixTime = BigInt(Math.floor(+date / 1000));
    const time = new SmartBuffer()
      .writeBigInt64LE(unixTime)
      .writeUInt16LE(date.getFullYear())
      .writeUInt16LE(date.getMonth() + 1)
      .writeUInt16LE(date.getDate())
      .writeUInt16LE(date.getHours())
      .writeUInt16LE(date.getMinutes())
      .writeUInt16LE(date.getSeconds())
      .writeUInt16LE(0);

    /*const encrypt = packetHandler.encrypt({ opcode: opCode.misc.ServerResCurrentDate, data: time.toBuffer() });
    this._session.getClient().write(encrypt, () => {
      cb();
    });*/
    this.write(opCode.misc.ServerResCurrentDate, time.toBuffer(), cb);
  }

  execute(opcode, data, loop = false) {
    this._opcode = opcode;
    this._data = data;

    switch (this._opcode) {
      case opCode.server.ClientReqWorldServerConnection:
        this.handleClientEnterGameServer();
        break;
      case opCode.character.ClientReqCharacterInfo:
        this.sendDummyChar();
        break;
      default:
        console.error("모르는거!", this._opcode, this._data.toString("hex"));
        break;
    }
  }
}
module.exports = GameHandler;
